<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel HERPLUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body { background:#0b1320; }
    .glass { background:rgba(17,24,39,0.9); backdrop-filter:blur(6px); }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; }
    .dot.green { background:#22c55e; box-shadow:0 0 8px #22c55e; }
    .dot.gray { background:#6b7280; }
    .pill { background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:2px 8px; border-radius:999px; font-size:12px; }
    .btn { padding:8px 12px; border-radius:8px; font-weight:600; }
    .btn-blue { background:#2563eb; } .btn-blue:hover{background:#1d4ed8;}
    .btn-gray { background:#4b5563; } .btn-gray:hover{background:#374151;}
    .btn-red  { background:#dc2626; } .btn-red:hover {background:#b91c1c;}
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="text-white min-h-screen">

  <!-- ===== Modal Login Admin (PIN) ===== -->
  <div id="adminLogin" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80">
    <div class="glass p-6 rounded w-full max-w-sm shadow-xl">
      <h2 class="text-xl font-bold mb-1 text-center">Panel HERPLUS</h2>
      <p class="text-sm text-gray-300 mb-4 text-center">Acceso administrador</p>

      <!-- Login -->
      <div id="loginBlock">
        <input id="adminPinInput" type="password" class="w-full p-2 rounded text-black mb-3" placeholder="PIN de administrador">
        <button id="btnAdminLogin" class="btn btn-blue w-full">Acceder</button>
      </div>

      <!-- Setup PIN (primer uso) -->
      <div id="setupBlock" class="hidden">
        <p class="text-sm text-gray-300 mb-2">No hay PIN configurado. Crea uno nuevo:</p>
        <input id="setupPin1" type="password" class="w-full p-2 rounded text-black mb-2" placeholder="Nuevo PIN">
        <input id="setupPin2" type="password" class="w-full p-2 rounded text-black mb-3" placeholder="Repetir PIN">
        <button id="btnSetupPin" class="btn btn-blue w-full">Guardar PIN</button>
      </div>

      <p id="adminMsg" class="text-sm mt-3 text-center text-red-300 hidden">Mensaje</p>
    </div>
  </div>

  <!-- ===== Modal Cambiar PIN ===== -->
  <div id="pinChangeModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-80">
    <div class="glass p-6 rounded w-full max-w-md shadow-xl relative">
      <button id="btnClosePinChange" class="absolute top-2 right-3 text-red-300 text-xl">‚úï</button>
      <h3 class="text-lg font-bold mb-4">Cambiar PIN</h3>
      <input id="pinCur" type="password" class="w-full p-2 rounded text-black mb-2" placeholder="PIN actual">
      <input id="pinNew1" type="password" class="w-full p-2 rounded text-black mb-2" placeholder="Nuevo PIN">
      <input id="pinNew2" type="password" class="w-full p-2 rounded text-black mb-3" placeholder="Repetir nuevo PIN">
      <div class="flex gap-2 justify-end">
        <button id="btnDoChangePin" class="btn btn-blue">Guardar</button>
        <button id="btnCancelChangePin" class="btn btn-gray">Cancelar</button>
      </div>
      <p id="pinChangeMsg" class="text-sm mt-3 text-red-300 hidden">Mensaje</p>
    </div>
  </div>

  <!-- ===== App (se muestra tras login) ===== -->
  <div id="appContainer" class="hidden p-6">

    <!-- Header -->
    <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-3xl font-bold mb-1">Panel de Administraci√≥n HERPLUS</h1>
        <p class="text-sm text-gray-300">
          Cambiar <b>pantallas</b> no afecta d√≠as. Cambiar <b>meses</b> reinicia el periodo (<code>fechaRegistro</code>).
        </p>
      </div>
      <div class="flex gap-2">
        <button id="btnOpenChangePin" class="btn btn-gray">Cambiar PIN</button>
        <button id="btnAdminLogout" class="btn btn-red">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- ===== Panel Principal ===== -->
    <div id="panelPrincipal" class="space-y-6">

      <!-- Crear Cliente -->
      <section class="mb-10">
        <h2 class="text-xl font-bold mb-2">üë§ Crear Cliente</h2>
        <div class="grid md:grid-cols-7 gap-4">
          <input id="nombre" type="text" placeholder="Nombre" class="p-2 rounded text-black">
          <input id="codigo" type="text" placeholder="C√≥digo" class="p-2 rounded text-black">
          <input id="meses" type="number" placeholder="Meses" class="p-2 rounded text-black">
          <input id="pantallas" type="number" placeholder="Pantallas" class="p-2 rounded text-black">
          <select id="activo" class="p-2 rounded text-black">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
          <button id="btnCrearCliente" class="bg-blue-600 px-4 py-2 rounded">Crear</button>
          <button id="btnRecargarUsuarios" class="bg-gray-600 px-4 py-2 rounded">Recargar</button>
        </div>
      </section>

      <!-- Listado de Usuarios + FILTROS -->
      <section class="mb-10">
        <h2 class="text-xl font-bold mb-2">üë• Usuarios Registrados</h2>

        <!-- Filtros de usuarios (NUEVO) -->
        <div class="glass p-4 rounded mb-4">
          <div class="grid md:grid-cols-5 gap-3 items-end">
            <div>
              <label class="block text-sm mb-1">Buscar</label>
              <input id="uBuscar" type="text" class="p-2 rounded text-black w-full" placeholder="Nombre o c√≥digo...">
            </div>
            <div>
              <label class="block text-sm mb-1">Estado</label>
              <select id="uEstado" class="p-2 rounded text-black w-full">
                <option value="">Todos</option>
                <option value="conectado">Conectados</option>
                <option value="desconectado">Desconectados</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">Vence en ‚â§ (d√≠as)</label>
              <input id="uVenceEn" type="number" min="0" class="p-2 rounded text-black w-full" placeholder="Ej. 7">
            </div>
            <div class="flex gap-2">
              <button id="uSoloPorVencer" class="btn btn-blue w-full">Solo por vencer (‚â§3d)</button>
              <button id="uLimpiarFiltros" class="btn btn-gray w-full">Limpiar</button>
            </div>
            <div class="text-right">
              <span id="uCounter" class="pill">0</span>
            </div>
          </div>
        </div>

        <div id="usuariosList" class="mt-4 space-y-3"></div>
      </section>

      <!-- Botones para acceder a paneles -->
      <div class="space-x-4">
        <button onclick="mostrarPanelSubirSeries()" class="bg-green-600 px-6 py-3 rounded text-white font-semibold">
          Subir / Editar Serie
        </button>
        <button onclick="mostrarPanelSubirPelicula()" class="bg-blue-600 px-6 py-3 rounded text-white font-semibold">
          Subir / Editar Pel√≠cula
        </button>
      </div>

      <!-- FILTROS PEL√çCULAS -->
      <section class="mt-8">
        <h2 class="text-xl font-bold mb-2">üéûÔ∏è Pel√≠culas</h2>
        <div class="flex flex-wrap gap-3 items-end mb-3">
          <div>
            <label class="block text-sm mb-1">Buscar</label>
            <input id="buscarPeliculas" type="text" class="p-2 rounded text-black" placeholder="T√≠tulo...">
          </div>
          <div>
            <label class="block text-sm mb-1">Categor√≠a</label>
            <select id="filtrarCategoriaPeliculas" class="p-2 rounded text-black">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="ml-auto text-sm text-gray-300">
            <span id="peliculasCounter">0 resultado(s)</span>
          </div>
        </div>
        <div id="contenidoListPeliculas" class="space-y-3"></div>

        <!-- FILTROS SERIES -->
        <h2 class="text-xl font-bold mb-4 mt-8">üì∫ Series</h2>
        <div class="flex flex-wrap gap-3 items-end mb-3">
          <div>
            <label class="block text-sm mb-1">Buscar</label>
            <input id="buscarSeries" type="text" class="p-2 rounded text-black" placeholder="T√≠tulo...">
          </div>
          <div>
            <label class="block text-sm mb-1">Categor√≠a</label>
            <select id="filtrarCategoriaSeries" class="p-2 rounded text-black">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="ml-auto text-sm text-gray-300">
            <span id="seriesCounter">0 resultado(s)</span>
          </div>
        </div>
        <div id="contenidoListSeries" class="space-y-3"></div>
      </section>
    </div>

    <!-- ===== Modal de Edici√≥n de Usuario (extendido) ===== -->
    <div id="modalEdicionUsuario" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center">
      <div class="bg-gray-800 p-6 rounded w-full max-w-xl relative">
        <button onclick="cerrarModalEdicion()" class="absolute top-2 right-3 text-red-500 text-xl font-bold">‚úñ</button>
        <h3 class="text-lg font-bold mb-4">Editar Usuario</h3>

        <!-- Info de fechas/d√≠as -->
        <div class="grid grid-cols-3 gap-3 text-sm text-gray-300 mb-3">
          <div>Registro: <b id="infoRegistro">‚Äî</b></div>
          <div>Vence: <b id="infoVence">‚Äî</b></div>
          <div>D√≠as restantes: <b id="infoDias">‚Äî</b></div>
        </div>

        <div class="grid gap-2">
          <input id="editNombre" class="p-2 rounded text-black" placeholder="Nombre" />
          <input id="editCodigo" class="p-2 rounded text-black" placeholder="C√≥digo" />
          <input id="editMeses" class="p-2 rounded text-black" placeholder="Meses" />
          <input id="editPantallas" class="p-2 rounded text-black" placeholder="Pantallas" />
          <select id="editActivo" class="p-2 rounded text-black">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
          <button id="btnGuardarUsuario" class="bg-blue-500 px-4 py-2 rounded mt-2">Guardar</button>
          <button onclick="cerrarModalEdicion()" class="bg-gray-600 px-4 py-2 rounded">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- ===== Modal de Edici√≥n de Pel√≠cula ===== -->
    <div id="modalEdicionPelicula" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center">
      <div class="bg-gray-800 p-6 rounded w-full max-w-xl relative">
        <button onclick="cerrarModalEdicionPelicula()" class="absolute top-2 right-3 text-red-500 text-xl font-bold">‚úñ</button>
        <h3 class="text-lg font-bold mb-4">Editar Pel√≠cula</h3>
        <div class="grid gap-2">
          <input id="editTituloPelicula" class="p-2 rounded text-black" placeholder="T√≠tulo" />
          <input id="editDescripcionPelicula" class="p-2 rounded text-black" placeholder="Descripci√≥n" />
          <input id="editImagenPelicula" class="p-2 rounded text-black" placeholder="Imagen (URL)" />
          <input id="editTrailerPelicula" class="p-2 rounded text-black" placeholder="Trailer (URL o iframe)" />
          <input id="editPelicula" class="p-2 rounded text-black" placeholder="Pel√≠cula (URL o iframe)" />
          <select id="editSeccionPelicula" class="p-2 rounded text-black">
            <option value="pelicula">Pel√≠cula</option>
            <option value="serie">Serie</option>
            <option value="tv">TV en vivo</option>
          </select>
          <select id="editCategoriaPelicula" class="p-2 rounded text-black"></select>
          <input id="editNuevaCategoriaPelicula" class="p-2 rounded text-black" placeholder="Agregar nueva categor√≠a (opcional)" />
          <button id="btnGuardarPelicula" class="bg-blue-500 px-4 py-2 rounded mt-2">Guardar</button>
          <button onclick="cerrarModalEdicionPelicula()" class="bg-gray-600 px-4 py-2 rounded">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- ===== Panel Subir Series ===== -->
    <div id="panelSubirSeries" class="hidden space-y-6">
      <h1 class="text-3xl font-bold mb-6">Series ‚Ä¢ Crear / Editar</h1>

      <div class="bg-gray-800 p-6 rounded-lg mb-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">T√≠tulo</label>
            <input id="tituloSerie" type="text" class="p-2 text-black rounded w-full" placeholder="T√≠tulo de la serie">
          </div>
          <div>
            <label class="block text-sm mb-1">Categor√≠a</label>
            <select id="categoriaSerie" class="p-2 text-black rounded w-full">
              <option value="">Seleccionar Categor√≠a</option>
            </select>
            <input id="nuevaCategoriaSerie" type="text" class="p-2 text-black rounded w-full mt-2" placeholder="Agregar nueva categor√≠a (opcional)">
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm mb-1">Portada (URL imagen)</label>
            <input id="imagenSerie" type="text" class="p-2 text-black rounded w-full" placeholder="https://...jpg">
          </div>
          <div>
            <label class="block text-sm mb-1">Tr√°iler (URL o iframe) (opcional)</label>
            <input id="trailerSerie" type="text" class="p-2 text-black rounded w-full" placeholder="https://... o &lt;iframe ...&gt;">
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm mb-1">Descripci√≥n</label>
          <textarea id="descripcionSerie" rows="3" class="p-2 text-black rounded w-full" placeholder="Resumen..."></textarea>
        </div>

        <div class="flex items-center justify-between mt-6">
          <h2 class="text-lg font-semibold">Temporadas</h2>
          <div class="space-x-2">
            <button id="btnAddTemp" class="bg-green-600 px-3 py-2 rounded">+ Agregar temporada</button>
            <button id="btnVistaPreviaSerie" class="bg-amber-500 px-3 py-2 rounded text-black">Vista previa</button>
            <button id="btnGuardarSerie" class="bg-blue-600 px-3 py-2 rounded">Guardar Serie</button>
            <button id="btnCancelarEdicionSerie" class="bg-gray-600 px-3 py-2 rounded hidden">Cancelar edici√≥n</button>
          </div>
        </div>

        <div id="contenedorTemporadas" class="space-y-4 mt-4"></div>
        <pre id="previewSerie" class="bg-black bg-opacity-40 p-3 rounded overflow-auto mt-4" style="max-height:260px; white-space:pre-wrap; font-size:12px;">{}</pre>
      </div>

      <button onclick="volverAlPanelPrincipal()" class="w-full bg-red-600 py-2 rounded text-white font-semibold">
        Volver al Panel Principal
      </button>
    </div>

    <!-- ===== Panel Subir Pel√≠cula ===== -->
    <div id="panelSubirPelicula" class="hidden space-y-6">
      <h1 class="text-3xl font-bold mb-6">Pel√≠culas ‚Ä¢ Crear</h1>

      <div class="bg-gray-800 p-6 rounded-lg mb-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">T√≠tulo</label>
            <input id="tituloPelicula" type="text" class="p-2 text-black rounded w-full">
          </div>
          <div>
            <label class="block text-sm mb-1">Categor√≠a</label>
            <select id="categoriaPelicula" class="p-2 text-black rounded w-full">
              <option value="">Seleccionar Categor√≠a</option>
            </select>
            <input id="nuevaCategoriaPelicula" type="text" class="p-2 text-black rounded w-full mt-2" placeholder="Agregar nueva categor√≠a (opcional)">
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm mb-1">Portada (URL imagen)</label>
            <input id="imagenPelicula" type="text" class="p-2 text-black rounded w-full" placeholder="https://...jpg">
          </div>
          <div>
            <label class="block text-sm mb-1">Tr√°iler (URL o iframe) (opcional)</label>
            <input id="trailerPelicula" type="text" class="p-2 text-black rounded w-full" placeholder="https://... o &lt;iframe ...&gt;">
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm mb-1">Pel√≠cula (URL o iframe)</label>
            <input id="pelicula" type="text" class="p-2 text-black rounded w-full" placeholder="https://... o &lt;iframe ...&gt;">
          </div>
          <div>
            <label class="block text-sm mb-1">Secci√≥n</label>
            <select id="seccionPelicula" class="p-2 text-black rounded w-full">
              <option value="pelicula">Pel√≠cula</option>
              <option value="tv">TV en vivo</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm mb-1">Descripci√≥n</label>
          <input id="descripcionPelicula" type="text" class="p-2 text-black rounded w-full">
        </div>

        <div class="flex gap-2 mt-6">
          <button id="btnSubirPelicula" class="bg-green-600 px-4 py-2 rounded">Subir Pel√≠cula</button>
          <button id="btnLimpiarPelicula" class="bg-gray-600 px-4 py-2 rounded">Limpiar</button>
        </div>
      </div>

      <button onclick="volverAlPanelPrincipal()" class="w-full bg-red-600 py-2 rounded text-white font-semibold">
        Volver al Panel Principal
      </button>
    </div>

  </div><!-- /appContainer -->

  <script>
    // ================= Firebase =================
    const firebaseConfig = {
      apiKey: "AIzaSyD_v8yXx1W6zcGFXXMHeNJh0RSzbnO-j84",
      authDomain: "herplus.firebaseapp.com",
      projectId: "herplus",
      storageBucket: "herplus.appspot.com",
      messagingSenderId: "556494279952",
      appId: "1:556494279952:web:f788776f50840b28434195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ================= Helpers =================
    const diaMs = 24*60*60*1000;
    const SESSION_TTL_MS = 3*60*1000; // 3 min

    const normalizeInt = (v,d=0)=>{ const n = parseInt(v,10); return isNaN(n)?d:n; };
    const normalizeStr = (v)=> (v||"").trim();

    function diasRestantes(fechaRegistro, meses){
      const fr = fechaRegistro?.toDate?.() ? fechaRegistro.toDate() : (fechaRegistro instanceof Date ? fechaRegistro : new Date());
      const fin = fr.getTime() + (Number(meses||0)*30*diaMs);
      const d = Math.max(0, Math.ceil((fin - Date.now())/diaMs));
      return { dias:d, finTs:fin };
    }
    function fmt(ts){
      const d = new Date(ts);
      return d.toLocaleDateString('es-ES',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    function tsToMs(v){ if(v?.toDate) return v.toDate().getTime(); if(typeof v==='number') return v; const n=Number(v); return isNaN(n)?Date.now():n; }
    function rel(ms){
      const diff = Date.now()-ms; const s=Math.max(0,Math.floor(diff/1000));
      if(s<60) return s+'s'; const m=Math.floor(s/60);
      if(m<60) return m+'m'; const h=Math.floor(m/60);
      if(h<24) return h+'h'; const d=Math.floor(h/24); return d+'d';
    }

    function normalizarUrlDrive(url){
      try{
        const u = new URL(url);
        if(u.hostname.includes("drive.google.com")){
          const m1=/\/file\/d\/([^/]+)/.exec(u.pathname);
          if(m1) return `https://drive.google.com/file/d/${m1[1]}/preview`;
          if(u.pathname==="/open" && u.searchParams.get("id")) return `https://drive.google.com/file/d/${u.searchParams.get("id")}/preview`;
          if(u.pathname==="/uc" && u.searchParams.get("id")) return `https://drive.google.com/file/d/${u.searchParams.get("id")}/preview`;
        }
        return url;
      }catch{ return url; }
    }
    const extraerSrcDeIframe = (html)=>{ const m=/src=["']([^"']+)["']/i.exec(html||""); return m?m[1]:""; }
    function parseFuente(valor){
      if(!valor) return "";
      const v = valor.trim();
      const src = v.includes("<iframe") ? (extraerSrcDeIframe(v) || v) : v;
      return normalizarUrlDrive(src);
    }
    async function ensureCategoria(nombre){
      nombre = normalizeStr(nombre);
      if(!nombre) return;
      const snap = await db.collection("categorias").where("nombre","==",nombre).limit(1).get();
      if (snap.empty) await db.collection("categorias").add({nombre});
    }

    // ================= Navegaci√≥n Paneles =================
    function mostrarPanelSubirSeries() {
      document.getElementById("appContainer").classList.remove("hidden");
      document.getElementById("panelPrincipal").classList.add("hidden");
      document.getElementById("panelSubirPelicula").classList.add("hidden");
      document.getElementById("panelSubirSeries").classList.remove("hidden");
    }
    function mostrarPanelSubirPelicula() {
      document.getElementById("appContainer").classList.remove("hidden");
      document.getElementById("panelPrincipal").classList.add("hidden");
      document.getElementById("panelSubirSeries").classList.add("hidden");
      document.getElementById("panelSubirPelicula").classList.remove("hidden");
    }
    function volverAlPanelPrincipal() {
      document.getElementById("panelSubirSeries").classList.add("hidden");
      document.getElementById("panelSubirPelicula").classList.add("hidden");
      document.getElementById("panelPrincipal").classList.remove("hidden");
      cancelarEdicionSerie();
    }

    // ================= Admin PIN Auth =================
    const ADMIN_DOC = db.collection('admin').doc('panel');
    const ADMIN_AUTH_TTL_MS = 6*60*60*1000; // 6h

    const $loginModal = document.getElementById('adminLogin');
    const $loginBlock = document.getElementById('loginBlock');
    const $setupBlock = document.getElementById('setupBlock');
    const $adminMsg = document.getElementById('adminMsg');
    const $app = document.getElementById('appContainer');

    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function showAdminLogin(){
      try{
        const snap = await ADMIN_DOC.get();
        if (!snap.exists || !snap.data()?.pinHash){
          $loginBlock.classList.add('hidden');
          $setupBlock.classList.remove('hidden');
          $adminMsg.classList.add('hidden');
        }else{
          $setupBlock.classList.add('hidden');
          $loginBlock.classList.remove('hidden');
          $adminMsg.classList.add('hidden');
        }
        $loginModal.classList.remove('hidden');
      }catch(e){
        console.error(e);
        $adminMsg.textContent = 'No se pudo cargar configuraci√≥n.';
        $adminMsg.classList.remove('hidden');
      }
    }
    async function tryAdminLogin(){
      const pin = (document.getElementById('adminPinInput').value || '').trim();
      if(!pin) return;
      const snap = await ADMIN_DOC.get();
      const cfg = snap.data() || {};
      if(!cfg.pinHash){
        $adminMsg.textContent = 'No hay PIN configurado. Crea uno primero.';
        $adminMsg.classList.remove('hidden');
        $loginBlock.classList.add('hidden');
        $setupBlock.classList.remove('hidden');
        return;
      }
      const hash = await sha256Hex(pin);
      if(hash === cfg.pinHash){
        sessionStorage.setItem('adminAuthedAt', String(Date.now()));
        $loginModal.classList.add('hidden');
        $app.classList.remove('hidden');
        init();
      }else{
        $adminMsg.textContent = 'PIN incorrecto.';
        $adminMsg.classList.remove('hidden');
      }
    }
    async function setupNewPin(){
      const p1=(document.getElementById('setupPin1').value||'').trim();
      const p2=(document.getElementById('setupPin2').value||'').trim();
      if(!p1 || p1.length<4){ $adminMsg.textContent='El PIN debe tener al menos 4 d√≠gitos.'; $adminMsg.classList.remove('hidden'); return; }
      if(p1!==p2){ $adminMsg.textContent='Los PIN no coinciden.'; $adminMsg.classList.remove('hidden'); return; }
      const hash = await sha256Hex(p1);
      await ADMIN_DOC.set({ pinHash:hash, createdAt:new Date() }, { merge:true });
      sessionStorage.setItem('adminAuthedAt', String(Date.now()));
      $loginModal.classList.add('hidden');
      $app.classList.remove('hidden');
      init();
    }
    function adminLogout(){ sessionStorage.removeItem('adminAuthedAt'); location.reload(); }
    function isAdminAuthed(){ const at=Number(sessionStorage.getItem('adminAuthedAt')||0); return at && (Date.now()-at)<ADMIN_AUTH_TTL_MS; }

    // Cambiar PIN UI
    const $pinModal = document.getElementById('pinChangeModal');
    document.getElementById('btnOpenChangePin').addEventListener('click', ()=> $pinModal.classList.remove('hidden'));
    document.getElementById('btnClosePinChange').addEventListener('click', ()=> $pinModal.classList.add('hidden'));
    document.getElementById('btnCancelChangePin').addEventListener('click', ()=> $pinModal.classList.add('hidden'));
    document.getElementById('btnAdminLogout').addEventListener('click', adminLogout);
    document.getElementById('btnAdminLogin').addEventListener('click', tryAdminLogin);
    document.getElementById('btnSetupPin').addEventListener('click', setupNewPin);
    document.getElementById('btnDoChangePin').addEventListener('click', async ()=>{
      const msg = document.getElementById('pinChangeMsg'); msg.classList.add('hidden');
      const cur=(document.getElementById('pinCur').value||'').trim();
      const n1=(document.getElementById('pinNew1').value||'').trim();
      const n2=(document.getElementById('pinNew2').value||'').trim();
      if(!cur||!n1||!n2){ msg.textContent='Completa todos los campos.'; msg.classList.remove('hidden'); return; }
      if(n1!==n2){ msg.textContent='El nuevo PIN no coincide.'; msg.classList.remove('hidden'); return; }
      if(n1.length<4){ msg.textContent='El nuevo PIN debe tener al menos 4 d√≠gitos.'; msg.classList.remove('hidden'); return; }
      const snap = await ADMIN_DOC.get(); const cfg=snap.data()||{};
      const curHash = await sha256Hex(cur);
      if(curHash!==cfg.pinHash){ msg.textContent='PIN actual incorrecto.'; msg.classList.remove('hidden'); return; }
      const newHash = await sha256Hex(n1);
      await ADMIN_DOC.set({ pinHash:newHash, updatedAt:new Date() }, { merge:true });
      msg.textContent='‚úÖ PIN actualizado.'; msg.classList.remove('hidden'); setTimeout(()=> $pinModal.classList.add('hidden'), 800);
      document.getElementById('pinCur').value=''; document.getElementById('pinNew1').value=''; document.getElementById('pinNew2').value='';
    });

    // Boot auth
    (async ()=>{ if(isAdminAuthed()){ document.getElementById('adminLogin').classList.add('hidden'); $app.classList.remove('hidden'); init(); } else { await showAdminLogin(); } })();

    // ================= Clientes =================
    let usuarioEditId = null;
    let usuarioEditPrev = null;

    document.getElementById("btnCrearCliente").addEventListener("click", async () => {
      const data = {
        nombre: normalizeStr(document.getElementById('nombre').value),
        codigo: normalizeStr(document.getElementById('codigo').value),
        meses: normalizeInt(document.getElementById('meses').value),
        pantallas: normalizeInt(document.getElementById('pantallas').value),
        activo: document.getElementById('activo').value === 'true',
        fechaRegistro: new Date()
      };
      if(!data.nombre || !data.codigo || !data.meses){
        alert("Completa nombre, c√≥digo y meses."); return;
      }
      await db.collection("clientes").add(data);
      alert("‚úÖ Cliente creado.");
      ['nombre','codigo','meses','pantallas'].forEach(id=>document.getElementById(id).value="");
      document.getElementById('activo').value='true';
      cargarUsuarios();
    });
    document.getElementById("btnRecargarUsuarios").addEventListener("click", cargarUsuarios);

    async function editarUsuario(id) {
      usuarioEditId = id;
      const doc = await db.collection("clientes").doc(id).get();
      const u = doc.data();
      usuarioEditPrev = { id, ...u };

      document.getElementById('editNombre').value = u.nombre || "";
      document.getElementById('editCodigo').value = u.codigo || "";
      document.getElementById('editMeses').value = u.meses ?? 0;
      document.getElementById('editPantallas').value = u.pantallas ?? 0;
      document.getElementById('editActivo').value = u.activo ? 'true' : 'false';

      const { dias, finTs } = diasRestantes(u.fechaRegistro, u.meses);
      document.getElementById('infoRegistro').textContent = u.fechaRegistro?.toDate ? fmt(u.fechaRegistro.toDate().getTime()) : '‚Äî';
      document.getElementById('infoVence').textContent = fmt(finTs);
      document.getElementById('infoDias').textContent = String(dias);

      document.getElementById("modalEdicionUsuario").classList.remove("hidden");
      document.getElementById("modalEdicionUsuario").classList.add("flex");
    }
    function cerrarModalEdicion() {
      document.getElementById("modalEdicionUsuario").classList.add("hidden");
      document.getElementById("modalEdicionUsuario").classList.remove("flex");
      usuarioEditId = null; usuarioEditPrev = null;
    }
    document.getElementById("btnGuardarUsuario").addEventListener("click", async () => {
      if (!usuarioEditId || !usuarioEditPrev) return;

      const nuevoNombre = normalizeStr(document.getElementById('editNombre').value);
      const nuevoCodigo = normalizeStr(document.getElementById('editCodigo').value);
      const nuevoMeses = normalizeInt(document.getElementById('editMeses').value, usuarioEditPrev.meses ?? 0);
      const nuevoPantallas = normalizeInt(document.getElementById('editPantallas').value, usuarioEditPrev.pantallas ?? 1);
      const nuevoActivo = document.getElementById('editActivo').value === 'true';

      const patch = {
        nombre: nuevoNombre || usuarioEditPrev.nombre || '',
        codigo: nuevoCodigo || usuarioEditPrev.codigo || '',
        pantallas: nuevoPantallas,
        activo: nuevoActivo
      };

      // Solo si cambia meses, reinicia periodo
      if (nuevoMeses !== (usuarioEditPrev.meses ?? 0)) {
        patch.meses = nuevoMeses;
        patch.fechaRegistro = new Date();
      }

      await db.collection("clientes").doc(usuarioEditId).update(patch);
      alert("‚úÖ Usuario actualizado.");
      cerrarModalEdicion();
      cargarUsuarios();
    });

    async function eliminarUsuario(id) {
      if (!confirm("¬øEliminar este usuario?")) return;
      await db.collection("clientes").doc(id).delete();
      cargarUsuarios();
    }

    // ====== Sesiones en vivo / ahora viendo ======
    const sessionUnsubs = new Map();
    function ts(val){ return val?.toDate ? val.toDate().getTime() : (typeof val==='number'?val:0); }

    async function toggleSessions(clienteId){
      const cont = document.getElementById(`sessions-${clienteId}`);
      const abierto = !cont.classList.contains('hidden');
      if (abierto) {
        cont.classList.add('hidden');
        const prev = sessionUnsubs.get(clienteId);
        if (prev){ try{prev();}catch{} sessionUnsubs.delete(clienteId); }
        return;
      }
      cont.classList.remove('hidden');
      const body = document.getElementById(`sessBody-${clienteId}`);
      const countEl = document.getElementById(`sessCount-${clienteId}`);
      body.innerHTML = `<tr><td class="py-3 text-gray-400" colspan="9">Cargando...</td></tr>`;

      const ref = db.collection('clientes').doc(clienteId).collection('sesiones');
      const unsub = ref.onSnapshot(snap=>{
        const now = Date.now();
        let active = 0;
        const rows = [];
        snap.forEach(d=>{
          const s = d.data();
          const createdMs = ts(s.createdAt);
          const lastMs = ts(s.lastSeen);
          const isActive = lastMs >= (now - SESSION_TTL_MS);
          if (isActive) active++;

          let viendo = '‚Äî';
          if (s.nowPlaying?.title){
            if (s.nowPlaying.type === 'serie' && (s.nowPlaying.season!=null) && (s.nowPlaying.episodeIndex!=null)){
              const eNum = s.nowPlaying.episodeIndex + 1;
              viendo = `${s.nowPlaying.title} ¬∑ T${s.nowPlaying.season}E${eNum}`;
            } else {
              viendo = s.nowPlaying.title;
            }
          } else if (s.playerOpen){
            viendo = '(Reproductor abierto)';
          }

          rows.push(`
            <tr class="${isActive?'':'opacity-60'}">
              <td class="py-2"><span class="dot ${isActive?'green':'gray'}"></span></td>
              <td class="py-2 mono pr-2">${(s.deviceId || d.id).slice(0,12)}‚Ä¶</td>
              <td class="py-2 pr-2">${viendo}</td>
              <td class="py-2 pr-2">${(s.ua||'').slice(0,60)}${(s.ua||'').length>60?'‚Ä¶':''}</td>
              <td class="py-2 pr-2">${createdMs?fmt(createdMs):'‚Äî'}</td>
              <td class="py-2 pr-2">${lastMs?fmt(lastMs):'‚Äî'}</td>
              <td class="py-2 pr-2">${lastMs?rel(lastMs):'‚Äî'}</td>
              <td class="py-2 pr-2">
                ${s.focused ? '<span class="pill">focused</span>' : ''}
                ${s.playerOpen ? '<span class="pill">player</span>' : ''}
              </td>
              <td class="py-2">
                <button class="btn btn-red" data-kill="${d.id}" data-cid="${clienteId}">Expulsar</button>
              </td>
            </tr>
          `);
        });
        body.innerHTML = rows.length ? rows.join('') : `<tr><td class="py-3 text-gray-400" colspan="9">Sin sesiones.</td></tr>`;
        countEl.textContent = `Activas: ${active} / Total: ${snap.size}`;
        body.querySelectorAll('[data-kill]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const sid = btn.getAttribute('data-kill');
            const cid = btn.getAttribute('data-cid');
            await db.collection('clientes').doc(cid).collection('sesiones').doc(sid).delete();
          });
        });
      });
      sessionUnsubs.set(clienteId, unsub);
    }
    async function killAllSessions(clienteId){
      if (!confirm('¬øExpulsar TODAS las sesiones de este cliente?')) return;
      const snap = await db.collection('clientes').doc(clienteId).collection('sesiones').get();
      const batch = db.batch();
      snap.forEach(d=> batch.delete(d.ref));
      await batch.commit();
    }

    // ===== Listado usuarios con filtros =====
    let usersCache = []; // enriquecidos con _dias, _activeCount, etc.

    function renderUsuariosList(list){
      const cont = document.getElementById("usuariosList");
      cont.innerHTML = "";

      list.forEach(c=>{
        const diasClase = c._dias<=3 ? 'text-yellow-300' : 'text-gray-300';
        const conectado = c._activeCount>0;
        const estadoHtml = conectado
          ? `<span class="dot green"></span> Conectado ¬∑ Sesiones: <b>${c._activeCount}</b>${c._nowPlayingStr ? ` ¬∑ Viendo: <b>${c._nowPlayingStr}</b>` : ''}`
          : `<span class="dot gray"></span> Desconectado ¬∑ √öltima conexi√≥n: <b>${c._lastSeenMax ? fmt(c._lastSeenMax) : '‚Äî'}</b>`;

        const wrapper = document.createElement('div');
        wrapper.className = "bg-gray-800 p-4 rounded";

        wrapper.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="space-y-1">
              <div class="text-lg font-semibold">${c.nombre || '‚Äî'} <span class="text-sm text-gray-400">(${c.codigo || '‚Äî'})</span></div>
              <div class="text-sm text-gray-300">Meses: <b>${c.meses ?? 0}</b> ‚Ä¢ Pantallas: <b>${c.pantallas ?? 0}</b> ‚Ä¢ Estado: <b>${c.activo ? 'Activo' : 'Inactivo'}</b></div>
              <div class="text-sm text-gray-300">Registrado: <b>${c.fechaRegistro?.toDate ? fmt(c.fechaRegistro.toDate().getTime()) : '‚Äî'}</b></div>
              <div class="text-sm ${diasClase}">Vence: <b>${fmt(c._venceTs)}</b> ‚Ä¢ D√≠as restantes: <b>${c._dias}</b></div>
              <div class="text-sm">${estadoHtml}</div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-blue" data-edit="${c.id}">Editar</button>
              <button class="btn btn-gray" data-sessions="${c.id}">Ver sesiones</button>
              <button class="btn btn-red" data-del="${c.id}">Eliminar</button>
            </div>
          </div>

          <div id="sessions-${c.id}" class="mt-3 hidden">
            <div class="flex items-center justify-between">
              <h4 class="font-semibold">Sesiones</h4>
              <div class="flex gap-2">
                <span class="pill" id="sessCount-${c.id}">‚Äî</span>
                <button class="btn btn-red" data-killall="${c.id}">Expulsar todas</button>
              </div>
            </div>
            <div class="overflow-x-auto mt-2">
              <table class="w-full text-sm">
                <thead class="text-gray-300">
                  <tr>
                    <th class="text-left py-2">Estado</th>
                    <th class="text-left py-2">Dispositivo</th>
                    <th class="text-left py-2">Viendo</th>
                    <th class="text-left py-2">User Agent</th>
                    <th class="text-left py-2">Creado</th>
                    <th class="text-left py-2">√öltimo latido</th>
                    <th class="text-left py-2">Hace</th>
                    <th class="text-left py-2">Flags</th>
                    <th class="text-left py-2">Acciones</th>
                  </tr>
                </thead>
                <tbody id="sessBody-${c.id}"></tbody>
              </table>
            </div>
          </div>
        `;

        wrapper.querySelector('[data-edit]').addEventListener('click', ()=> editarUsuario(c.id));
        wrapper.querySelector('[data-del]').addEventListener('click', ()=> eliminarUsuario(c.id));
        wrapper.querySelector('[data-sessions]').addEventListener('click', ()=> toggleSessions(c.id));
        wrapper.querySelector('[data-killall]').addEventListener('click', ()=> killAllSessions(c.id));

        cont.appendChild(wrapper);
      });

      if (!list.length){
        cont.innerHTML = `<div class="text-gray-400">Sin resultados.</div>`;
      }
      document.getElementById('uCounter').textContent = `${list.length} usuario(s)`;
    }

    function applyUserFilters(){
      const txt = (document.getElementById('uBuscar').value||'').toLowerCase();
      const est = document.getElementById('uEstado').value; // '', 'conectado', 'desconectado'
      const vence = normalizeInt(document.getElementById('uVenceEn').value, 0);

      const filtered = usersCache.filter(u=>{
        const okTxt = !txt || (u.nombre||'').toLowerCase().includes(txt) || (u.codigo||'').toLowerCase().includes(txt);
        const okEst = est==='' || (est==='conectado' ? u._activeCount>0 : u._activeCount===0);
        const okVence = vence<=0 || u._dias <= vence;
        return okTxt && okEst && okVence;
      });
      renderUsuariosList(filtered);
    }

    async function cargarUsuarios() {
      // Cerrar watchers previos
      sessionUnsubs.forEach(unsub=>{ try{unsub();}catch{} });
      sessionUnsubs.clear();

      const snap = await db.collection("clientes").orderBy("nombre").get();
      const arr = [];

      for (const doc of snap.docs){
        const u = doc.data();
        const { dias, finTs } = diasRestantes(u.fechaRegistro, u.meses);

        let active=0, lastMax=0, nowPlayingStr='';
        const ss = await db.collection('clientes').doc(doc.id).collection('sesiones').orderBy('lastSeen','desc').get();
        const cutoff = Date.now() - SESSION_TTL_MS;
        ss.forEach(sdoc=>{
          const s = sdoc.data();
          const last = tsToMs(s.lastSeen);
          if (last>lastMax) lastMax = last;
          if (last >= cutoff){
            active++;
            if (s.nowPlaying?.title){
              const np=s.nowPlaying;
              if (np.type==='serie' && (np.season!=null) && (np.episodeIndex!=null)){
                nowPlayingStr = nowPlayingStr || `${np.title} ¬∑ T${np.season}E${np.episodeIndex+1}`;
              } else {
                nowPlayingStr = nowPlayingStr || np.title;
              }
            }
          }
        });

        arr.push({ id:doc.id, ...u, _dias:dias, _venceTs:finTs, _activeCount:active, _lastSeenMax:lastMax, _nowPlayingStr:nowPlayingStr });
      }

      usersCache = arr;
      applyUserFilters(); // pinta con los filtros actuales
    }

    // ================= Categor√≠as (para selects y filtros) =================
    async function cargarCategorias() {
      const selects = [
        document.getElementById("categoriaSerie"),
        document.getElementById("categoriaPelicula"),
        document.getElementById("editCategoriaPelicula"),
        document.getElementById("filtrarCategoriaPeliculas"),
        document.getElementById("filtrarCategoriaSeries")
      ];
      selects.forEach(sel=>{
        if (!sel) return;
        const first = sel.id.startsWith('filtrar') ? 'Todas' : 'Seleccionar Categor√≠a';
        sel.innerHTML = `<option value="">${first}</option>`;
      });
      const snap = await db.collection("categorias").get();
      snap.forEach(doc=>{
        const nombre = doc.data().nombre;
        selects.forEach(sel=>{
          if (!sel) return;
          const opt = document.createElement("option");
          opt.value = nombre; opt.textContent = nombre;
          sel.appendChild(opt.cloneNode(true));
        });
      });
    }

    // ================= Pel√≠culas/Series listas (Realtime) =================
    let peliculasCache = [];
    let seriesCache = [];
    let unsubPeliculas = null;
    let unsubSeries = null;

    function renderPeliculasList(list){
      const contenedor = document.getElementById("contenidoListPeliculas");
      contenedor.innerHTML = "";
      list.sort((a,b)=> (a.titulo||"").localeCompare(b.titulo||""));
      list.forEach(doc => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-4 rounded flex items-center justify-between";
        div.innerHTML = `
          <div>
            <strong>${doc.titulo || '(Sin t√≠tulo)'}</strong> ‚Äî <span class="text-sm">${doc.categoria || 'Sin categor√≠a'}</span>
          </div>
          <div class="space-x-2">
            <button class="bg-blue-600 px-2 py-1 rounded" onclick="editarPelicula('${doc.id}')">Editar</button>
            <button class="bg-red-600 px-2 py-1 rounded" onclick="eliminarContenido('${doc.id}')">Eliminar</button>
          </div>
        `;
        contenedor.appendChild(div);
      });
      document.getElementById('peliculasCounter').textContent = `${list.length} resultado(s)`;
    }
    function renderSeriesList(list){
      const contenedor = document.getElementById("contenidoListSeries");
      contenedor.innerHTML = "";
      list.sort((a,b)=> (a.titulo||"").localeCompare(b.titulo||""));
      list.forEach(doc => {
        const temporadas = Array.isArray(doc.temporadas) ? doc.temporadas.length : 0;
        const episodios = (doc.temporadas||[]).reduce((acc,t)=>acc + (t.episodios?.length||0),0);
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-4 rounded flex items-center justify-between";
        div.innerHTML = `
          <div>
            <strong>${doc.titulo || '(Sin t√≠tulo)'}</strong> ‚Äî <span class="text-sm">${doc.categoria || 'Sin categor√≠a'}</span><br>
            <span class="text-xs">${temporadas} temporada(s), ${episodios} episodio(s)</span>
          </div>
          <div class="space-x-2">
            <button class="bg-blue-600 px-2 py-1 rounded" onclick="editarSerie('${doc.id}')">Editar</button>
            <button class="bg-red-600 px-2 py-1 rounded" onclick="eliminarContenido('${doc.id}')">Eliminar</button>
          </div>
        `;
        contenedor.appendChild(div);
      });
      document.getElementById('seriesCounter').textContent = `${list.length} resultado(s)`;
    }

    function applyPeliculasFilters(){
      const txt = (document.getElementById('buscarPeliculas').value || "").toLowerCase();
      const cat = document.getElementById('filtrarCategoriaPeliculas').value;
      const filtered = peliculasCache.filter(p =>
        (!txt || (p.titulo||"").toLowerCase().includes(txt)) &&
        (!cat || p.categoria === cat)
      );
      renderPeliculasList(filtered);
    }
    function applySeriesFilters(){
      const txt = (document.getElementById('buscarSeries').value || "").toLowerCase();
      const cat = document.getElementById('filtrarCategoriaSeries').value;
      const filtered = seriesCache.filter(s =>
        (!txt || (s.titulo||"").toLowerCase().includes(txt)) &&
        (!cat || s.categoria === cat)
      );
      renderSeriesList(filtered);
    }

    function startRealtimeLists(){
      if (unsubPeliculas) unsubPeliculas();
      if (unsubSeries) unsubSeries();

      unsubPeliculas = db.collection("peliculas").where("seccion","==","pelicula")
        .onSnapshot(snap=>{
          peliculasCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
          applyPeliculasFilters();
        });

      unsubSeries = db.collection("peliculas").where("seccion","==","serie")
        .onSnapshot(snap=>{
          seriesCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
          applySeriesFilters();
        });
    }

    // ================= Eliminar contenido (pel√≠culas/series) =================
    function eliminarContenido(id) {
      if (confirm("¬øEliminar este contenido?")) {
        db.collection("peliculas").doc(id).delete();
      }
    }

    // ================= Pel√≠culas: Crear / Editar =================
    document.getElementById("btnSubirPelicula").addEventListener("click", async ()=>{
      const titulo = normalizeStr(document.getElementById('tituloPelicula').value);
      const categoriaSel = document.getElementById('categoriaPelicula').value;
      const categoriaNueva = normalizeStr(document.getElementById('nuevaCategoriaPelicula').value);
      const categoria = categoriaNueva || categoriaSel;
      const imagen = normalizeStr(document.getElementById('imagenPelicula').value) || 'img/placeholder.jpg';
      const trailerRaw = normalizeStr(document.getElementById('trailerPelicula').value);
      const peliculaRaw = normalizeStr(document.getElementById('pelicula').value);
      const seccion = document.getElementById('seccionPelicula').value || 'pelicula';
      const descripcion = normalizeStr(document.getElementById('descripcionPelicula').value);

      if (!titulo || !categoria || !peliculaRaw) { alert("T√≠tulo, categor√≠a y pel√≠cula son obligatorios."); return; }
      if (categoriaNueva) await ensureCategoria(categoriaNueva);

      const trailer = trailerRaw ? parseFuente(trailerRaw) : "";
      const pelicula = parseFuente(peliculaRaw);

      await db.collection("peliculas").add({ titulo, descripcion, imagen, trailer, pelicula, seccion, categoria });
      alert("‚úÖ Pel√≠cula guardada.");

      ['tituloPelicula','descripcionPelicula','imagenPelicula','trailerPelicula','pelicula','nuevaCategoriaPelicula'].forEach(id=>document.getElementById(id).value="");
      document.getElementById('seccionPelicula').value="pelicula";
      volverAlPanelPrincipal();
    });
    document.getElementById("btnLimpiarPelicula").addEventListener("click", ()=>{
      ['tituloPelicula','descripcionPelicula','imagenPelicula','trailerPelicula','pelicula','nuevaCategoriaPelicula'].forEach(id=>document.getElementById(id).value="");
      document.getElementById('seccionPelicula').value="pelicula";
    });

    let peliculaEditId = null;
    async function editarPelicula(id){
      peliculaEditId = id;
      await cargarCategorias();
      const docRef = await db.collection("peliculas").doc(id).get();
      const p = docRef.data();
      document.getElementById('editTituloPelicula').value = p.titulo || "";
      document.getElementById('editDescripcionPelicula').value = p.descripcion || "";
      document.getElementById('editImagenPelicula').value = p.imagen || "";
      document.getElementById('editTrailerPelicula').value = p.trailer || "";
      document.getElementById('editPelicula').value = p.pelicula || "";
      document.getElementById('editSeccionPelicula').value = p.seccion || "pelicula";
      document.getElementById('editCategoriaPelicula').value = p.categoria || "";
      document.getElementById("modalEdicionPelicula").classList.remove("hidden");
    }
    document.getElementById("btnGuardarPelicula").addEventListener("click", async ()=>{
      if(!peliculaEditId) return;
      const categoriaSel = document.getElementById('editCategoriaPelicula').value;
      const categoriaNueva = normalizeStr(document.getElementById('editNuevaCategoriaPelicula').value);
      const categoria = categoriaNueva || categoriaSel;
      if (categoriaNueva) await ensureCategoria(categoriaNueva);

      const updated = {
        titulo: normalizeStr(document.getElementById('editTituloPelicula').value),
        descripcion: normalizeStr(document.getElementById('editDescripcionPelicula').value),
        imagen: normalizeStr(document.getElementById('editImagenPelicula').value),
        trailer: parseFuente(document.getElementById('editTrailerPelicula').value),
        pelicula: parseFuente(document.getElementById('editPelicula').value),
        seccion: document.getElementById('editSeccionPelicula').value || 'pelicula',
        categoria
      };
      await db.collection("peliculas").doc(peliculaEditId).update(updated);
      alert("‚úÖ Pel√≠cula actualizada.");
      peliculaEditId = null;
      cerrarModalEdicionPelicula();
    });
    function cerrarModalEdicionPelicula(){
      document.getElementById("modalEdicionPelicula").classList.add("hidden");
      document.getElementById('editNuevaCategoriaPelicula').value = "";
    }

    // ================= Series: Crear / Editar =================
    const contTemps = document.getElementById('contenedorTemporadas');
    function crearFilaEpisodio(ep={}) {
      const row = document.createElement('div');
      row.className = 'grid md:grid-cols-12 gap-2 items-end bg-gray-900 p-2 rounded';
      row.innerHTML = `
        <div class="md:col-span-2">
          <label class="text-xs">N¬∫ Ep.</label>
          <input class="p-2 text-black rounded w-full inp-ep-num" type="number" min="1" value="${ep.numero ?? ''}">
        </div>
        <div class="md:col-span-5">
          <label class="text-xs">T√≠tulo</label>
          <input class="p-2 text-black rounded w-full inp-ep-titulo" value="${ep.titulo ?? ''}" placeholder="Piloto">
        </div>
        <div class="md:col-span-4">
          <label class="text-xs">Fuente (URL o iframe)</label>
          <input class="p-2 text-black rounded w-full inp-ep-valor" value="${ep.url ?? ep.iframe ?? ''}" placeholder="https://... o <iframe ...>">
          <p class="text-xs text-gray-300">Drive se normaliza a /preview autom√°ticamente.</p>
        </div>
        <div class="md:col-span-1">
          <button class="bg-red-600 px-2 py-2 rounded w-full btn-del-ep">X</button>
        </div>
      `;
      row.querySelector('.btn-del-ep').addEventListener('click', ()=> row.remove());
      return row;
    }
    function crearBloqueTemporada(t={}) {
      const wrap = document.createElement('div');
      wrap.className = 'rounded-lg p-3 bg-gray-800 border border-gray-700';
      wrap.innerHTML = `
        <div class="grid md:grid-cols-3 gap-3">
          <div>
            <label class="text-xs">N¬∫ Temporada</label>
            <input class="p-2 text-black rounded w-full inp-numero-temp" type="number" min="1" value="${t.numero ?? ''}">
          </div>
          <div class="md:col-span-2">
            <label class="text-xs">Nombre</label>
            <input class="p-2 text-black rounded w-full inp-nombre-temp" value="${t.nombre ?? ''}" placeholder="Temporada 1">
          </div>
        </div>
        <div class="flex items-center justify-between mt-3">
          <h3 class="font-semibold text-blue-300">Episodios</h3>
          <div class="space-x-2">
            <button class="bg-green-600 px-3 py-1 rounded btn-add-ep">+ Episodio</button>
            <button class="bg-red-600 px-3 py-1 rounded btn-del-temp">Eliminar temporada</button>
          </div>
        </div>
        <div class="space-y-2 cont-episodios mt-2"></div>
      `;
      wrap.querySelector('.btn-add-ep').addEventListener('click', ()=>{
        wrap.querySelector('.cont-episodios').appendChild(crearFilaEpisodio());
      });
      wrap.querySelector('.btn-del-temp').addEventListener('click', ()=>{
        if(confirm("¬øEliminar temporada?")) wrap.remove();
      });
      const cont = wrap.querySelector('.cont-episodios');
      (t.episodios||[]).forEach(ep=> cont.appendChild(crearFilaEpisodio(ep)));
      if (!(t.episodios && t.episodios.length)) cont.appendChild(crearFilaEpisodio());
      return wrap;
    }

    function construirSerieDesdeForm() {
      const titulo = normalizeStr(document.getElementById('tituloSerie').value);
      const categoriaSel = document.getElementById('categoriaSerie').value;
      const categoriaNueva = normalizeStr(document.getElementById('nuevaCategoriaSerie').value);
      const categoria = categoriaNueva || categoriaSel || 'Sin categor√≠a';
      const imagen = normalizeStr(document.getElementById('imagenSerie').value) || 'img/placeholder.jpg';
      const trailerRaw = normalizeStr(document.getElementById('trailerSerie').value);
      const descripcion = normalizeStr(document.getElementById('descripcionSerie').value);

      let trailer = "";
      if (trailerRaw) trailer = parseFuente(trailerRaw);

      const temporadas = [];
      contTemps.querySelectorAll('.rounded-lg.p-3.bg-gray-800').forEach((wrap)=>{
        const numero = normalizeInt(wrap.querySelector('.inp-numero-temp').value, null);
        const nombre = normalizeStr(wrap.querySelector('.inp-nombre-temp').value) || (numero ? `Temporada ${numero}` : 'Temporada');

        const episodios = [];
        wrap.querySelectorAll('.cont-episodios > div').forEach((row, idx)=>{
          const epNum = normalizeInt(row.querySelector('.inp-ep-num').value, null);
          const epTitulo = normalizeStr(row.querySelector('.inp-ep-titulo').value) || `Episodio ${idx+1}`;
          const epVal = normalizeStr(row.querySelector('.inp-ep-valor').value);
          const url = parseFuente(epVal);
          if (url) {
            const obj = { titulo: epTitulo, url };
            if (epNum) obj.numero = epNum;
            episodios.push(obj);
          }
        });

        if (episodios.length) {
          const tempObj = { nombre, episodios };
          if (numero) tempObj.numero = numero;
          temporadas.push(tempObj);
        }
      });

      temporadas.sort((a,b)=>(a.numero??0)-(b.numero??0));
      return { titulo, descripcion, imagen, categoria, seccion:"serie", trailer, temporadas };
    }
    function validarSerie(s) {
      const errs = [];
      if (!s.titulo) errs.push("‚Ä¢ El t√≠tulo es obligatorio.");
      if (!s.categoria) errs.push("‚Ä¢ La categor√≠a es obligatoria.");
      if (!s.temporadas.length) errs.push("‚Ä¢ Agrega al menos una temporada con episodios.");
      s.temporadas.forEach((t, ti)=>{
        if (!t.episodios?.length) errs.push(`‚Ä¢ La temporada ${t.nombre||ti+1} no tiene episodios.`);
        t.episodios?.forEach((ep, ei)=>{
          if (!ep.url) errs.push(`‚Ä¢ Falta URL en T${t.numero??ti+1} E${ep.numero??ei+1}.`);
        });
      });
      return errs;
    }

    document.getElementById('btnAddTemp').addEventListener('click', ()=> contTemps.appendChild(crearBloqueTemporada()));
    document.getElementById('btnVistaPreviaSerie').addEventListener('click', ()=>{
      const s = construirSerieDesdeForm();
      document.getElementById('previewSerie').textContent = JSON.stringify(s,null,2);
    });
    let serieEditId = null;
    document.getElementById('btnGuardarSerie').addEventListener('click', async ()=>{
      const s = construirSerieDesdeForm();
      const errs = validarSerie(s);
      document.getElementById('previewSerie').textContent = JSON.stringify(s,null,2);
      if (errs.length) { alert("Revisa:\n"+errs.join("\n")); return; }

      const categoriaNueva = normalizeStr(document.getElementById('nuevaCategoriaSerie').value);
      if (categoriaNueva) await ensureCategoria(categoriaNueva);

      if (serieEditId) { await db.collection("peliculas").doc(serieEditId).update(s); alert("‚úÖ Serie actualizada."); }
      else { await db.collection("peliculas").add(s); alert("‚úÖ Serie creada."); }

      cancelarEdicionSerie();
      volverAlPanelPrincipal();
    });
    function cancelarEdicionSerie(){
      serieEditId = null;
      document.getElementById('btnCancelarEdicionSerie').classList.add('hidden');
      ['tituloSerie','imagenSerie','trailerSerie','descripcionSerie','nuevaCategoriaSerie'].forEach(id=>document.getElementById(id).value="");
      document.getElementById('categoriaSerie').value="";
      document.getElementById('previewSerie').textContent="{}";
      contTemps.innerHTML="";
    }
    async function editarSerie(id){
      await cargarCategorias();
      const doc = await db.collection("peliculas").doc(id).get();
      const s = doc.data();
      serieEditId = id;
      mostrarPanelSubirSeries();
      document.getElementById('btnCancelarEdicionSerie').classList.remove('hidden');

      document.getElementById('tituloSerie').value = s.titulo || "";
      document.getElementById('categoriaSerie').value = s.categoria || "";
      document.getElementById('imagenSerie').value = s.imagen || "";
      document.getElementById('trailerSerie').value = s.trailer || "";
      document.getElementById('descripcionSerie').value = s.descripcion || "";
      contTemps.innerHTML = "";
      (s.temporadas||[]).forEach(t=> contTemps.appendChild(crearBloqueTemporada(t)));
      if (!s.temporadas || !s.temporadas.length) contTemps.appendChild(crearBloqueTemporada());
      document.getElementById('previewSerie').textContent = JSON.stringify(s,null,2);
    }

    // ======= Listeners filtros usuarios =======
    document.getElementById('uBuscar').addEventListener('input', applyUserFilters);
    document.getElementById('uEstado').addEventListener('change', applyUserFilters);
    document.getElementById('uVenceEn').addEventListener('input', applyUserFilters);
    document.getElementById('uSoloPorVencer').addEventListener('click', ()=>{
      document.getElementById('uVenceEn').value = 3;
      document.getElementById('uEstado').value = ''; // no forzamos estado
      applyUserFilters();
    });
    document.getElementById('uLimpiarFiltros').addEventListener('click', ()=>{
      document.getElementById('uBuscar').value = '';
      document.getElementById('uEstado').value = '';
      document.getElementById('uVenceEn').value = '';
      applyUserFilters();
    });

    // ================= Filtros Pel√≠culas/Series =================
    document.getElementById('buscarPeliculas').addEventListener('input', applyPeliculasFilters);
    document.getElementById('filtrarCategoriaPeliculas').addEventListener('change', applyPeliculasFilters);
    document.getElementById('buscarSeries').addEventListener('input', applySeriesFilters);
    document.getElementById('filtrarCategoriaSeries').addEventListener('change', applySeriesFilters);

    // ================= Init (tras login) =================
    async function init(){
      await cargarCategorias();
      await cargarUsuarios();
      startRealtimeLists();
    }
  </script>

</body>
</html>








